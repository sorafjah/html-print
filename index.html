<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ルビふりお2 - 画像対応版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            body * { visibility: hidden; }
            #preview-container, #preview-container * { visibility: visible; }
            #preview-container {
                position: absolute;
                left: 0; top: 0; width: 100%; margin: 0; padding: 0;
                box-shadow: none; background: white;
            }
            .page-hp { box-shadow: none !important; margin: 0 !important; width: 100% !important; height: auto !important; }
            .page-a4 { box-shadow: none !important; margin: 0 !important; width: 100% !important; height: auto !important; }
            ruby { ruby-position: over; }
        }

        .preview-content {
            font-family: "BIZ UDPGothic", "BIZ UDGothic", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", "Yu Gothic", sans-serif;
            line-height: 2.0;
            overflow-wrap: break-word;
            font-size: 12pt;
        }

        .page-hp { width: 100%; padding: 2rem; background: white; min-height: 100%; }
        .page-a4 {
            width: 210mm; min-height: 297mm; padding: 20mm; margin: 0 auto;
            background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); box-sizing: border-box;
        }

        .ruby-edit-mode ruby {
            display: inline-ruby;
            position: relative;
            cursor: pointer;
            border-radius: 4px;
            border-bottom: 1px dotted #ccc;
        }
        .ruby-edit-mode ruby:hover { background-color: #e0f2fe; }
        .ruby-edit-mode ruby.editing-active {
            background-color: #fce7f3; outline: 2px solid #ec4899; z-index: 10;
        }
        rt { display: ruby-text; font-size: 0.5em; line-height: 1; text-align: center; color: #555; user-select: none; }

        /* 画像のデフォルトスタイル */
        #preview-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem auto;
        }

        #preview-container table { border-collapse: collapse; margin: 0.5em 0; }
        #preview-container th, #preview-container td { border: 1px solid #999; padding: 4px 8px; }
        #preview-container th { background: #f3f4f6; font-weight: bold; }

        #web-iframe { width: 100%; height: 100%; border: none; background: white; }
        #html-editor { font-family: monospace; white-space: pre-wrap; }

        .mode-btn { padding: 4px 14px; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; cursor: pointer; transition: all 0.15s; }
        .mode-btn.active { background: #3b82f6; color: white; }
        .mode-btn:not(.active) { background: #e5e7eb; color: #374151; }
        .mode-btn:not(.active):hover { background: #d1d5db; }

        .text-edit-mode { cursor: text; outline: none; }
        .text-edit-mode:focus { outline: none; }
        .text-edit-mode ruby { cursor: text !important; border-bottom: none !important; }
        .text-edit-mode ruby:hover { background-color: transparent !important; }

        #edit-mode-indicator {
            display: inline-flex; align-items: center; gap: 4px; font-size: 0.7rem; font-weight: bold; padding: 2px 8px; border-radius: 9999px; transition: all 0.2s;
        }
        #edit-mode-indicator.mode-ruby { background: #dcfce7; color: #16a34a; }
        #edit-mode-indicator.mode-text { background: #fef9c3; color: #a16207; }

        /* 画像選択時のスタイル */
        img.img-editing { outline: 3px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

<header class="bg-white shadow-sm z-10 p-3 flex justify-between items-center shrink-0">
    <h1 class="text-xl font-bold text-gray-700">ルビふりお2 <span class="text-xs font-normal text-blue-500">画像対応</span></h1>
    <div class="flex gap-2">
        <button onclick="openInNewTab()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-1.5 rounded text-sm transition">
            <i class="fas fa-external-link-alt mr-1"></i> 新しいタブ
        </button>
        <button onclick="copyHtml()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1.5 rounded text-sm transition">
            <i class="fas fa-code mr-1"></i> HTMLコピー
        </button>
        <button onclick="window.print()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-1.5 rounded text-sm transition">
            <i class="fas fa-print mr-1"></i> 印刷
        </button>
    </div>
</header>

<div class="bg-white border-b border-gray-200 p-2 flex flex-wrap gap-3 items-center shrink-0 text-sm">
    <div class="flex items-center border-r pr-3 gap-2">
        <span class="text-gray-500 text-xs font-bold uppercase">レイアウト</span>
        <select id="layout-select" onchange="changeLayout()" class="border border-gray-300 rounded p-1">
            <option value="hp">HP用 (Web)</option>
            <option value="a4">A4印刷用</option>
        </select>
    </div>

    <div class="flex items-center border-r pr-3 gap-2">
        <span class="text-gray-500 text-xs font-bold uppercase">全体サイズ</span>
        <div class="flex items-center">
            <input type="number" id="base-font-size" value="12" min="6" max="72" class="w-14 border border-gray-300 rounded p-1 text-center" onchange="updateBaseFontSize()">
            <span class="ml-1 text-gray-600 text-xs">pt</span>
        </div>
    </div>

    <div class="flex items-center border-r pr-3 gap-1">
        <select id="font-family-select" onchange="wrapFontFamily(this.value); this.value='';" class="border border-gray-300 rounded p-1 w-24 mr-1 text-xs">
            <option value="" disabled selected>フォント</option>
            <option value="">デフォルト</option>
            <option value="'UD Digi Kyokasho', 'YuKyokasho', 'Kaisho', serif">教科書体</option>
            <option value="'HiraMinProN-W3', 'YuMincho', serif">明朝体</option>
            <option value="'Hiragino Kaku Gothic ProN', sans-serif">ゴシック</option>
        </select>
        <button onmousedown="event.preventDefault()" onclick="wrapSelection('b')" class="p-1.5 hover:bg-gray-100 rounded" title="太字"><i class="fas fa-bold"></i></button>
        <button onmousedown="event.preventDefault()" onclick="wrapColor('red')" class="p-1.5 hover:bg-gray-100 rounded text-red-500" title="赤文字"><i class="fas fa-font"></i></button>
        <!-- 画像挿入ボタン -->
        <button onmousedown="event.preventDefault()" onclick="openImageModal()" class="p-1.5 hover:bg-blue-50 text-blue-600 rounded border border-transparent hover:border-blue-200" title="画像挿入"><i class="fas fa-image"></i></button>
    </div>

    <div class="flex items-center border border-gray-300 rounded px-1 ml-1 bg-gray-50" id="partial-fontsize-box">
        <span class="text-[10px] text-gray-500 mr-1 font-bold">選択文字</span>
        <input type="number" id="sel-font-size" value="16" class="w-10 p-0.5 text-center text-xs border-none bg-transparent focus:ring-0 outline-none">
        <span class="text-[10px] text-gray-500 mr-1">pt</span>
        <button onmousedown="event.preventDefault()" onclick="applyPartialFontSize()" class="ml-1 text-xs text-gray-600 hover:text-blue-500 px-1"><i class="fas fa-check"></i></button>
    </div>

    <div class="flex items-center gap-2 ml-auto">
        <a href="https://gemini.google.com/gem/1aQXlT177ks4j2LLC5ooZCyZV3xKGBIlx?usp=sharing" target="_blank" class="text-xs bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-1 rounded hover:bg-indigo-100 transition shadow-sm">
            <i class="fas fa-external-link-alt mr-2"></i> ルビGem
        </a>
    </div>
</div>

<div class="flex flex-1 overflow-hidden">
    <!-- エディタ -->
    <div class="w-1/2 flex flex-col border-r border-gray-300 bg-gray-50">
        <div class="p-2 bg-gray-100 border-b text-xs font-bold text-gray-500 flex justify-between items-center">
            <span>HTMLソース入力</span>
            <span class="text-[10px] bg-gray-200 px-2 py-0.5 rounded text-gray-400">Ctrl+Vで画像貼り付け可</span>
        </div>
        <textarea id="html-editor" 
            class="flex-1 w-full p-4 resize-none focus:outline-none focus:ring-2 focus:ring-blue-300 text-gray-800 text-sm leading-relaxed font-mono"
            placeholder="<!-- HTMLを貼り付けるか画像を挿入してください -->"
            oninput="updatePreview()"></textarea>
    </div>

    <!-- プレビュー -->
    <div class="w-1/2 flex flex-col bg-gray-200 overflow-hidden" id="preview-scroller">
        <div class="p-2 bg-gray-200/90 backdrop-blur border-b border-gray-300 flex justify-between items-center text-xs font-bold text-gray-500 shrink-0">
            <div class="flex items-center gap-2">
                <button id="btn-mode-ruby" class="mode-btn active" onclick="setPreviewMode('ruby')">
                    <i class="fas fa-pen mr-1"></i>ルビ・画像編集
                </button>
                <button id="btn-mode-web" class="mode-btn" onclick="setPreviewMode('web')">
                    <i class="fas fa-globe mr-1"></i>Web
                </button>
                <div class="ml-2 flex items-center gap-1 border-l pl-2">
                    <span id="edit-mode-indicator" class="mode-ruby">
                        <i class="fas fa-circle text-[6px]"></i> ルビ修正モード
                    </span>
                    <button id="btn-edit-toggle" onclick="toggleEditMode()" class="text-[10px] bg-white border border-gray-300 hover:bg-yellow-50 px-2 py-0.5 rounded transition">
                        切替
                    </button>
                </div>
            </div>
            <span id="preview-hint" class="text-gray-400">クリックでルビ・画像修正</span>
        </div>

        <div class="flex justify-center p-4 min-h-0 flex-1 overflow-y-auto" id="preview-scroll-inner">
            <div id="preview-container" class="page-hp preview-content ruby-edit-mode" spellcheck="false"></div>
            <iframe id="web-iframe" class="hidden" sandbox="allow-same-origin allow-scripts"></iframe>
        </div>
    </div>
</div>

<!-- ルビ編集モーダル -->
<div id="ruby-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96 shadow-xl relative">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg text-gray-700">ルビ修正</h3>
        </div>
        <div class="flex gap-4 mb-6 items-end">
            <div class="flex-1 text-center">
                <label class="block text-xs text-gray-400 mb-1">漢字</label>
                <div id="modal-kanji-display" class="text-2xl font-bold bg-gray-100 p-2 rounded"></div>
            </div>
            <div class="flex-1">
                <label class="block text-xs text-blue-500 font-bold mb-1">ふりがな</label>
                <input type="text" id="modal-ruby" class="w-full text-xl border-b-2 border-blue-500 p-2 focus:outline-none bg-transparent text-center" autocomplete="off">
            </div>
        </div>
        <div class="flex justify-between gap-2 mb-4">
            <button onclick="navigateRuby(-1)" class="flex-1 py-1 px-2 text-sm bg-gray-100 hover:bg-gray-200 rounded">前へ</button>
            <button onclick="navigateRuby(1)" class="flex-1 py-1 px-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded font-bold">保存して次へ</button>
        </div>
        <div class="flex justify-end pt-4 border-t gap-3">
            <button onclick="closeRubyModal()" class="text-gray-400 text-sm">閉じる</button>
            <button onclick="removeRubyTag()" class="text-red-400 text-sm">解除</button>
        </div>
    </div>
</div>

<!-- 画像設定モーダル -->
<div id="image-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60]">
    <div class="bg-white rounded-lg p-6 w-[450px] shadow-xl relative">
        <h3 class="font-bold text-lg text-gray-700 mb-4"><i class="fas fa-image mr-2 text-blue-500"></i>画像の設定</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">画像URL / Googleドライブ共有URL</label>
                <input type="text" id="img-url" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="https://...">
                <p class="text-[10px] text-gray-400 mt-1">※Googleドライブの共有リンクは自動で表示用URLに変換されます</p>
            </div>
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 mb-1">幅 (px または %)</label>
                    <input type="text" id="img-width" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="例: 400px または 100%">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 mb-1">説明 (alt)</label>
                    <input type="text" id="img-alt" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="画像の説明">
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6 gap-2">
            <button onclick="closeImageModal()" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
            <button id="img-delete-btn" onclick="deleteCurrentImage()" class="hidden px-4 py-2 text-sm text-red-500 hover:bg-red-50 rounded">削除</button>
            <button onclick="insertOrUpdateImage()" class="px-4 py-2 text-sm bg-blue-500 text-white rounded font-bold hover:bg-blue-600">決定</button>
        </div>
    </div>
</div>

<script>
    const editor = document.getElementById('html-editor');
    const preview = document.getElementById('preview-container');
    const baseFontSizeInput = document.getElementById('base-font-size');
    const selFontSizeInput = document.getElementById('sel-font-size');
    const webIframe = document.getElementById('web-iframe');
    const previewHint = document.getElementById('preview-hint');
    const editModeIndicator = document.getElementById('edit-mode-indicator');

    let currentTargetRuby = null;
    let currentTargetImg = null;
    let lastRange = null;
    let currentMode = 'ruby'; 
    let editMode = 'ruby';

    window.addEventListener('DOMContentLoaded', () => {
        updateBaseFontSize();
        updatePreview();
    });

    // =====================
    // 画像URL変換 (Googleドライブ対応)
    // =====================
    function convertDriveUrl(url) {
        if (!url) return "";
        // Googleドライブの共有リンク ( /file/d/ID/view )
        const driveRegex = /\/file\/d\/([^\/]+)\//;
        const match = url.match(driveRegex);
        if (match && match[1]) {
            return `https://lh3.googleusercontent.com/d/${match[1]}`;
        }
        return url;
    }

    // =====================
    // 画像モーダル処理
    // =====================
    function openImageModal(imgElement = null) {
        const modal = document.getElementById('image-modal');
        const urlInput = document.getElementById('img-url');
        const widthInput = document.getElementById('img-width');
        const altInput = document.getElementById('img-alt');
        const deleteBtn = document.getElementById('img-delete-btn');

        if (imgElement) {
            currentTargetImg = imgElement;
            urlInput.value = imgElement.src;
            widthInput.value = imgElement.style.width || imgElement.width || "";
            altInput.value = imgElement.alt || "";
            deleteBtn.classList.remove('hidden');
        } else {
            currentTargetImg = null;
            urlInput.value = "";
            widthInput.value = "";
            altInput.value = "";
            deleteBtn.classList.add('hidden');
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        urlInput.focus();
    }

    function closeImageModal() {
        document.getElementById('image-modal').classList.add('hidden');
        document.getElementById('image-modal').classList.remove('flex');
        if (currentTargetImg) {
            currentTargetImg.classList.remove('img-editing');
            currentTargetImg = null;
        }
    }

    function insertOrUpdateImage() {
        const url = convertDriveUrl(document.getElementById('img-url').value);
        const width = document.getElementById('img-width').value;
        const alt = document.getElementById('img-alt').value;

        if (!url) return alert("URLを入力してください");

        if (currentTargetImg) {
            // 更新
            currentTargetImg.src = url;
            currentTargetImg.alt = alt;
            if (width) currentTargetImg.style.width = width;
            else currentTargetImg.style.width = "";
        } else {
            // 新規挿入
            const style = width ? ` style="width:${width}"` : "";
            const imgHtml = `<img src="${url}" alt="${alt}"${style}>`;
            
            // エディタに挿入
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            editor.value = text.substring(0, start) + imgHtml + text.substring(end);
        }
        
        syncPreviewToEditor();
        updatePreview();
        closeImageModal();
    }

    function deleteCurrentImage() {
        if (currentTargetImg && confirm("画像を削除しますか？")) {
            currentTargetImg.remove();
            syncPreviewToEditor();
            closeImageModal();
        }
    }

    // =====================
    // 編集モード切替
    // =====================
    function toggleEditMode() {
        if (currentMode !== 'ruby') return;
        if (editMode === 'ruby') setEditMode('text');
        else { syncPreviewToEditor(); setEditMode('ruby'); }
    }

    function setEditMode(mode) {
        editMode = mode;
        if (mode === 'text') {
            preview.contentEditable = 'true';
            preview.classList.remove('ruby-edit-mode');
            preview.classList.add('text-edit-mode');
            editModeIndicator.innerHTML = '<i class="fas fa-circle text-[6px]"></i> テキスト編集モード';
            editModeIndicator.className = 'mode-text';
            previewHint.textContent = 'テキストを直接編集できます';
            preview.querySelectorAll('ruby').forEach(r => r.onclick = null);
            preview.querySelectorAll('img').forEach(i => i.onclick = null);
        } else {
            preview.contentEditable = 'false';
            preview.classList.add('ruby-edit-mode');
            preview.classList.remove('text-edit-mode');
            editModeIndicator.innerHTML = '<i class="fas fa-circle text-[6px]"></i> ルビ修正モード';
            editModeIndicator.className = 'mode-ruby';
            previewHint.textContent = 'クリックでルビ・画像修正';
            attachEditEvents();
        }
    }

    // =====================
    // プレビュー更新
    // =====================
    function updatePreview() {
        if (currentMode === 'web') { updateWebIframe(); return; }
        if (editMode === 'text') return;

        const rawText = editor.value;
        preview.innerHTML = smartBrConvert(rawText);
        attachEditEvents();
    }

    function attachEditEvents() {
        preview.querySelectorAll('ruby').forEach(ruby => {
            ruby.onclick = (e) => { e.stopPropagation(); openRubyModal(ruby); };
        });
        preview.querySelectorAll('img').forEach(img => {
            img.onclick = (e) => { 
                e.stopPropagation(); 
                img.classList.add('img-editing');
                openImageModal(img); 
            };
            img.title = "画像設定を開く";
        });
    }

    function smartBrConvert(html) {
        const PRESERVE_TAGS = ['table', 'pre', 'ol', 'ul', 'dl', 'style', 'script'];
        const pattern = new RegExp(`(<(?:${PRESERVE_TAGS.join('|')})[^>]*>[\\s\\S]*?</(?:${PRESERVE_TAGS.join('|')})>)`, 'gi');
        const blocks = [];
        let processed = html.replace(pattern, (match) => {
            const idx = blocks.length;
            blocks.push(match);
            return `\x00BLOCK${idx}\x00`;
        });
        processed = processed.replace(/\n/g, '<br>');
        processed = processed.replace(/\x00BLOCK(\d+)\x00/g, (_, idx) => blocks[parseInt(idx)]);
        return processed;
    }

    function updateBaseFontSize() {
        preview.style.fontSize = (parseInt(baseFontSizeInput.value) || 12) + 'pt';
    }

    function changeLayout() {
        const type = document.getElementById('layout-select').value;
        preview.className = `preview-content ruby-edit-mode ${type === 'a4' ? 'page-a4' : 'page-hp'}`;
    }

    // =====================
    // 同期処理
    // =====================
    function syncPreviewToEditor() {
        const clone = preview.cloneNode(true);
        clone.querySelectorAll('table br').forEach(br => br.replaceWith(document.createTextNode('\x00TDBR\x00')));
        clone.querySelectorAll('br').forEach(br => br.replaceWith(document.createTextNode('\n')));
        
        // 不要なクラスをクリーンアップ
        clone.querySelectorAll('.editing-active, .img-editing').forEach(el => {
            el.classList.remove('editing-active', 'img-editing');
        });

        let html = clone.innerHTML;
        html = html.replace(/\x00TDBR\x00/g, '<br>');
        editor.value = html;
    }

    // =====================
    // ルビ機能
    // =====================
    const modal = document.getElementById('ruby-modal');
    const modalKanjiDisplay = document.getElementById('modal-kanji-display');
    const modalRuby = document.getElementById('modal-ruby');

    function openRubyModal(rubyElement) {
        if (editMode !== 'ruby') return;
        if (currentTargetRuby) currentTargetRuby.classList.remove('editing-active');
        currentTargetRuby = rubyElement;
        currentTargetRuby.classList.add('editing-active');
        
        let kanjiText = "";
        rubyElement.childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE) kanjiText += node.textContent;
        });
        const rt = rubyElement.querySelector('rt');
        modalKanjiDisplay.textContent = kanjiText;
        modalRuby.value = rt ? rt.textContent : "";
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modalRuby.focus();
    }

    function closeRubyModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        if (currentTargetRuby) {
            currentTargetRuby.classList.remove('editing-active');
            currentTargetRuby = null;
        }
    }

    function navigateRuby(direction) {
        if (!currentTargetRuby) return;
        const rt = currentTargetRuby.querySelector('rt');
        if (rt) rt.textContent = modalRuby.value;
        syncPreviewToEditor();
        
        const allRubies = Array.from(preview.querySelectorAll('ruby'));
        const nextIndex = allRubies.indexOf(currentTargetRuby) + direction;
        if (nextIndex >= 0 && nextIndex < allRubies.length) {
            openRubyModal(allRubies[nextIndex]);
        } else {
            closeRubyModal();
        }
    }

    function removeRubyTag() {
        if (!currentTargetRuby) return;
        let kanjiText = "";
        currentTargetRuby.childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE) kanjiText += node.textContent;
        });
        currentTargetRuby.parentNode.replaceChild(document.createTextNode(kanjiText), currentTargetRuby);
        syncPreviewToEditor();
        closeRubyModal();
    }

    // =====================
    // 装飾
    // =====================
    function applyStyleToSelection(startTag, endTag) {
        const sel = window.getSelection();
        if (sel.rangeCount > 0 && preview.contains(sel.anchorNode)) {
            const range = sel.getRangeAt(0);
            const content = range.extractContents();
            const wrapper = document.createElement('div');
            wrapper.innerHTML = startTag + ' ' + endTag;
            const tag = wrapper.firstElementChild;
            tag.innerHTML = "";
            tag.appendChild(content);
            range.insertNode(tag);
            syncPreviewToEditor();
        } else {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            editor.value = text.substring(0, start) + startTag + text.substring(start, end) + endTag + text.substring(end);
            updatePreview();
        }
    }
    function wrapSelection(tag) { applyStyleToSelection(`<${tag}>`, `</${tag}>`); }
    function wrapColor(color) { applyStyleToSelection(`<span style="color:${color}">`, `</span>`); }
    function wrapFontFamily(font) { if(font) applyStyleToSelection(`<span style="font-family:${font}">`, `</span>`); }
    function applyPartialFontSize() {
        const size = parseInt(selFontSizeInput.value);
        if (size >= 6) applyStyleToSelection(`<span style="font-size:${size}pt">`, `</span>`);
    }

    // =====================
    // その他
    // =====================
    function setPreviewMode(mode) {
        currentMode = mode;
        const btnRuby = document.getElementById('btn-mode-ruby');
        const btnWeb = document.getElementById('btn-mode-web');
        if (mode === 'ruby') {
            btnRuby.classList.add('active'); btnWeb.classList.remove('active');
            preview.classList.remove('hidden'); webIframe.classList.add('hidden');
        } else {
            btnWeb.classList.add('active'); btnRuby.classList.remove('active');
            preview.classList.add('hidden'); webIframe.classList.remove('hidden');
            updateWebIframe();
        }
    }

    function updateWebIframe() {
        const html = editor.value;
        const size = parseInt(baseFontSizeInput.value) || 12;
        webIframe.srcdoc = `<html><head><style>body{font-family:sans-serif;font-size:${size}pt;line-height:2.0;padding:1.5rem;} table{border-collapse:collapse;} th,td{border:1px solid #999;padding:4px 8px;} img{max-width:100%;height:auto;display:block;margin:1rem auto;}</style></head><body>${html}</body></html>`;
    }

    function copyHtml() {
        navigator.clipboard.writeText(editor.value).then(() => alert('コピーしました'));
    }

    function openInNewTab() {
        const blob = new Blob([`<html><head><meta charset="UTF-8"><style>body{font-family:sans-serif;padding:2rem;line-height:2.0;} table{border-collapse:collapse;} th,td{border:1px solid #999;padding:4px 8px;} img{max-width:100%;height:auto;}</style></head><body>${editor.value}</body></html>`], { type: 'text/html' });
        window.open(URL.createObjectURL(blob), '_blank');
    }

    // 貼り付けイベントで画像を取得 (エディタ上)
    editor.addEventListener('paste', (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf("image") !== -1) {
                e.preventDefault();
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imgHtml = `<img src="${event.target.result}" alt="貼り付けた画像" style="width:100%">`;
                    const start = editor.selectionStart;
                    const text = editor.value;
                    editor.value = text.substring(0, start) + imgHtml + text.substring(editor.selectionEnd);
                    updatePreview();
                };
                reader.readAsDataURL(blob);
            }
        }
    });

    modalRuby.addEventListener('keydown', (e) => { if (e.key === 'Enter') navigateRuby(1); });
</script>
</body>
</html>
